name: detect-worker-format

on:
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Pull raw data from Worker
        run: |
          set -e
          WORKER_URL="https://collector.zenyamail88.workers.dev/gold"
          mkdir -p work

          echo "[detect] Fetching $WORKER_URL"
          curl -fsSL "$WORKER_URL" -o work/raw.txt || {
            echo "[detect] curl failed"
            exit 1
          }

          echo "[detect] Raw preview:"
          head -c 500 work/raw.txt || true
          echo

      - name: Detect format
        run: |
          set -e
          RAW="work/raw.txt"

          if jq -e 'type=="array"' "$RAW" >/dev/null 2>&1; then
            echo "FORMAT=array"
            exit 0
          fi

          if jq -e 'type=="object" and has("items") and (.items|type=="array")' "$RAW" >/dev/null 2>&1; then
            echo "FORMAT=object.items"
            exit 0
          fi

          if jq -e 'type=="object" and has("status")' "$RAW" >/dev/null 2>&1; then
            echo "FORMAT=report/status"
            exit 0
          fi

          echo "FORMAT=invalid_or_html"
          echo "----- RAW (first 300 chars) -----"
          head -c 300 "$RAW" || true
          exit 0
